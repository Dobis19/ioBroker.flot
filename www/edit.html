<html>
<head>
    <title>Flot Edit</title>
    <link href="img/favicon.png" rel="shortcut icon" type="image/x-icon" />
    <link type="text/css" rel="stylesheet" href="../../lib/css/themes/jquery-ui/default/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="../../lib/css/fancytree/ui.fancytree.min.css"/>
    <link type="text/css" rel="stylesheet" href="lib/css/jquery.colorpicker.css"/>

    <script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="../../lib/js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/selectID.js"></script>
    <script type="text/javascript" src="../../lib/js/socket.io.js"></script>
    <script type="text/javascript" src="lib/js/jquery-deparam.js"></script>
    <script type="text/javascript" src="lib/js/jquery.colorpicker.js"></script>

    <script type="text/javascript" src="../../_socket/info.js"></script>
    <script type="text/javascript" src="js/words.js"></script>
    <script type="text/javascript" src="js/settings.js"></script>

    <style>
        .input {
            /*width: 150px;*/
        }

        .input_time {
            width: 80px;
        }

        .label {
            width: 130px;
        }

        .ui-widget input {
            font-size: 14px;
        }

        .header {
            font-weight: bold;
            background: white;
            color: black;
        }

        body {
            font-family: Arial
        }

        h3 {
            line-height: 0.3!important;
            font-size: 15px!important;
        }

        .ui-accordion-content {
            padding: 5px 10px !important;
        }

        #accordion {
            font-size: 14px !important;
        }

        #accordion>div {
            padding: 3px;
        }

        table.fixed td { overflow: hidden; }
        table.fixed th { overflow: hidden; }

        .no-spaces {
            border-collapse: collapse;
            border-spacing: 0;
        }

        /*.ui-resizable-s {
            cursor: s-resize;
            height: 10px;
            bottom: -5px;
            left: 0;
            right: 0;
            background-color: gray;
        }*/
        .version {
            position: absolute;
            top: 14px;
            right: 10px;
            color: white;
        }

    </style>
</head>
<body style="height: calc(100% - 16px); width: 100%; margin: 0; padding: 0;">

<div id="resizable1" style="overflow: hidden; height: 360px">
    <div style="height: calc(100% - 75px); position: relative; overflow: hidden;">
        <div id="accordion" style="">
            <ul>
                <li><a href="#chapter_ids" class="translate">Input data</a></li>
                <li><a href="#chapter_markline" class="translate">Markings</a></li>
                <li><a href="#chapter_time" class="translate">Time</a></li>
                <li><a href="#chapter_options" class="translate">Options</a></li>
            </ul>
            <!--h3><span class="translate">Input data</span><span style="float:right; font-weight: normal; color: #959595">Version: 1.5.7</span></h3-->
            <div id="chapter_ids" style="width: 100%; height: 100%">
                <table>
                    <tr>
                        <td colspan="7">
                            <button style="margin-left: 1px" id="ids_add" class="translateB">Add new line</button>
                            <button id="clear" title="Reset settings" class="translateT" style="float: left;">Clear</button>
                            <span class="translate" style="padding-left: 20px">Auto-update:</span><input type="checkbox" id="autoUpdate"/>
                            <button id="arrangeBools" class="translateB button_arrange_bools">Arrange bools</button>
                        </td>
                    </tr>
                </table>
                <div style="width: 100%;">
                    <table style="table-layout: fixed;" class="fixed" id="idslist_table"  border="0" cellspacing="0" cellpadding="0">
                        <tbody id="idslist"></tbody>
                    </table>
                </div>
            </div>
            <!--h3 class="markline-option"><span class="translate">Markings</span></h3-->
            <div id="chapter_markline" class="markline-option" style="width: 100%; height: 100%;">
                <table style="width: 100%">
                    <tr>
                        <td colspan="7">
                            <button style="margin-left: 1px" id="markline_add" class="translateB">Add new markings</button>
                        </td>
                    </tr>
                </table>
                <div style="width: 100%; height: 100%">
                    <table style="table-layout: fixed;" class="fixed" id="markline_table"  border="0" cellspacing="0" cellpadding="0">
                        <thead id="markline_head">
                        <tr class="header">
                            <td class="translate" style="width: 30%; white-space: nowrap">Line ID</td>
                            <td class="translate" style="width: 130px; white-space: nowrap">Upper value or ID</td>
                            <td class="translate" style="width: 40px;"></td>
                            <td class="translate" style="width: 130px; white-space: nowrap">Lower value or ID</td>
                            <td class="translate" style="width: 40px;"></td>
                            <td class="translate" style="width: 180px">Color</td>
                            <td class="translate" style="width: 80px">Fill</td>
                            <td class="translate" style="width: 80px">&#216L</td>
                            <td class="translate" style="width: 80px">&#216S</td>
                            <td class="translate" style="width: 30%">Text</td>
                            <td class="translate" style="width: 150px; white-space: nowrap">Text position</td>
                            <td class="translate" style="width: 100px; white-space: nowrap">Text offset</td>
                            <td class="translate" style="width: 100px; white-space: nowrap">Text size</td>
                            <td class="translate" style="width: 180px; white-space: nowrap">Text color</td>
                            <td class="translate" style="width: 80px"></td>
                        </tr>
                        </thead>
                        <tbody id="markline_list"></tbody>
                    </table>
                </div>
            </div>
            <!--h3 class="chapter_time"><span class="translate">Time</span> <span id="time_span"></span></h3-->
            <div id="chapter_time" style="display: flex" class="chapter_time">
                <table >
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Time Span</td>
                    </tr>
                    <tr class="time_timeType">
                        <td class="translate">Aggregation:</td>
                        <td><select id="timeType" class="input value">
                            <option value="relative" class="translate">relative</option>
                            <option value="static"   class="translate">static</option>
                        </select></td>
                    </tr>
                    <tr class="relative time_relativeEnd">
                        <td class="translate">End:</td>
                        <td><select id="relativeEnd" class="input value">
                            <option value="now"         class="translate">now</option>
                            <option value="1minute"     class="translate">end of minute</option>
                            <option value="5minutes"    class="translate">end of 5 minutes</option>
                            <option value="10minutes"   class="translate">end of 10 minutes</option>
                            <option value="30minutes"   class="translate">end of 30 minutes</option>
                            <option value="1hour"       class="translate">end of hour</option>
                            <option value="2hours"      class="translate">end of 2 hours</option>
                            <option value="3hours"      class="translate">end of 3 hours</option>
                            <option value="4hours"      class="translate">end of 4 hours</option>
                            <option value="6hours"      class="translate">end of 6 hours</option>
                            <option value="8hours"      class="translate">end of 8 hours</option>
                            <option value="12hours"     class="translate">end of 12 hours</option>
                            <option value="today"       class="translate">end of day</option>
                            <option value="weekEurope"  class="translate">end of sunday</option>
                            <option value="weekUsa"     class="translate">end of saturday</option>
                            <option value="month"       class="translate">this month</option>
                            <option value="year"        class="translate">this year</option>
                        </select></td>
                    </tr>
                    <tr class="relative time_range">
                        <td class="translate">Range:</td>
                        <td><select id="range"      class="value input">
                            <option value="10"      class="translate">10 minutes</option>
                            <option value="30"      class="translate">30 minutes</option>
                            <option value="60"      class="translate">1 hour</option>
                            <option value="120"     class="translate">2 hours</option>
                            <option value="180"     class="translate">3 hours</option>
                            <option value="360"     class="translate">6 hours</option>
                            <option value="720"     class="translate">12 hours</option>
                            <option value="1440"    class="translate">1 day</option>
                            <option value="2880"    class="translate">2 days</option>
                            <option value="4320"    class="translate">3 days</option>
                            <option value="10080"   class="translate">7 days</option>
                            <option value="20160"   class="translate">14 days</option>
                            <option value="1m"      class="translate">1 month</option>
                            <option value="2m"      class="translate">2 months</option>
                            <option value="3m"      class="translate">3 months</option>
                            <option value="6m"      class="translate">6 months</option>
                            <option value="1y"      class="translate">1 year</option>
                            <option value="2y"      class="translate">2 years</option>
                        </select></td>
                    </tr>
                    <tr class="relative time_live">
                        <td class="translate">Live update every:</td>
                        <td><select class="value" id="live">
                            <option value=""        class="translate">none</option>
                            <option value="5"       class="translate">5 seconds</option>
                            <option value="10"      class="translate">10 seconds</option>
                            <option value="15"      class="translate">15 seconds</option>
                            <option value="20"      class="translate">20 seconds</option>
                            <option value="30"      class="translate">30 seconds</option>
                            <option value="60"      class="translate">1 minute</option>
                            <option value="120"     class="translate">2 minutes</option>
                            <option value="300"     class="translate">5 minutes</option>
                            <option value="600"     class="translate">10 minutes</option>
                            <option value="900"     class="translate">15 minutes</option>
                            <option value="1200"    class="translate">20 minutes</option>
                            <option value="1800"    class="translate">30 minutes</option>
                            <option value="3600"    class="translate">1 hour</option>
                            <option value="7200"    class="translate">2 hours</option>
                            <option value="10800"   class="translate">3 hours</option>
                            <option value="21600"   class="translate">6 hours</option>
                            <option value="43200"   class="translate">12 hours</option>
                            <option value="86400"   class="translate">1 day</option>
                        </select></td>
                    </tr>
                    <tr class="static time_start">
                        <td class="translate">Start:</td>
                        <td><input type="date" id="start" class="value input"> <input type="time" id="start_time" class="value input_time"></td>
                    </tr>
                    <tr class="static time_end">
                        <td class="translate">End:</td>
                        <td><input type="date" id="end" class="value input"> <input type="time" id="end_time" class="value input_time"></td>
                    </tr>
                </table>

                <table style="margin-left: 25px">
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Aggregate</td>
                    </tr>
                    <tr class="time_aggregateType">
                        <td class="translate ">Step type:</td>
                        <td><select id="aggregateType" class="value input">
                            <option value="count" class="translate">counts</option>
                            <option value="step" class="translate">seconds</option>
                        </select></td>
                    </tr>
                    <tr class="time_aggregateSpan">
                        <td class="translate" id="spanName">Step span:</td>
                        <td><input id="aggregateSpan" value="300" class="value input"></td>
                    </tr>
                    <tr class="time_ticks">
                        <td><label class="translate" for="ticks">Ticks from:</label></td>
                        <td><table class="no-spaces"><tr><td><input id="ticks" class="value input" style="display: inline;" /></td><td><button style="display: inline; margin-right: 15px;" id="ticks_select"></button></td></tr></table></td>
                    </tr>
                </table>
            </div>
            <!--h3 class="translate chapter_options">Options</h3-->
            <div id="chapter_options" style="display: flex" class="chapter_options">
                <table style="width: 380px">
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Appearance</td>
                    </tr>
                    <tr class="options_width">
                        <td style="width: 270px"><label class="translate" for="width">Width:</label></td>
                        <td><input id="width" class="value input spinner"/></td>
                    </tr>
                    <tr class="options_height">
                        <td><label class="translate" for="height">Height:</label></td>
                        <td><input id="height" class="value input spinner"></td>
                    </tr>
                    <tr class="options_noborder">
                        <td><label class="translate" for="noBorder">No border:</label></td>
                        <td><select class="value input" id="noBorder">
                            <option value="" class="translate"></option>
                            <option value="noborder" class="translate">yes</option>
                        </select></td>
                    </tr>
                    <tr class="options_window_bg">
                        <td class="label"><label class="translate" for="window_bg">Window background:</label></td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" id="window_bg" class="value input input-static-color" style="display: inline-block"></td><td><button data-clear="window_bg" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_bg_custom">
                        <td class="label"><label class="translate" for="bg_custom">Custom chart background:</label></td>
                        <td>
                            <input type="checkbox" id="bg_custom">
                        </td>
                    </tr>
                    <tr class="options_bg">
                        <td class="label"><label class="bg_predefined" for="bg_custom">Chart background:</label></td>
                        <td>
                            <select id="bg_predefined">
                                <option value="" class="translate">default</option>
                                <option value="0">Portrait</option>
                                <option value="1">Instagram</option>
                                <option value="2">ServQuick</option>
                                <option value="3">Metallic Toad</option>
                                <option value="4">Clouds</option>
                                <option value="5">Mirage</option>
                                <option value="6">Steel Gray</option>
                                <option value="7">Horizon</option>
                                <option value="8">Koko Caramel</option>
                                <option value="9">Turquoise flow</option>
                            </select>
                            <input type="text" id="bg" class="value input" style="display: none"/>
                        </td>
                    </tr>
                    <tr class="options_x_labels_color">
                        <td class="translate label">X axis labels color:</td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="x_labels_color"></td><td><button data-clear="x_labels_color" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_y_labels_color">
                        <td class="translate label">Y axis labels color:</td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="y_labels_color"></td><td><button data-clear="y_labels_color" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_border_color">
                        <td><label class="translate label" for="border_color">Border color:</label></td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="border_color"></td><td><button data-clear="border_color" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_grid_color">
                        <td class="translate label">Grid color:</td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="grid_color"></td><td><button data-clear="grid_color" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_border_width">
                        <td class="translate label">Border width:</td>
                        <td>
                            <input type="text" class="value input" id="border_width">
                        </td>
                    </tr>
                </table>

                <table style="width: 340px" class="options-bar">
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Bar settings</td>
                    </tr>
                    <tr class="options_barColor">
                        <td><label  class="translate" for="barColor">Fill color:</label></td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="barColor"></td><td><button data-clear="barColor" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                    <tr class="options_barLabels">
                        <td><label  class="translate" for="barLabels">Show labels:</label></td>
                        <td><select id="barLabels" class="value input">
                            <option value=""       class="translate">none</option>
                            <option value="topover"  class="translate">top over</option>
                            <option value="topunder" class="translate">top under</option>
                            <option value="bottom"   class="translate">bottom</option>
                            <option value="middle"   class="translate">middle</option>
                        </select></td>
                    </tr>
                    <tr class="options_barWidth">
                        <td><label class="translate" for="barWidth">Bars width:</label></td>
                        <td><input id="barWidth" class="value input"></td>
                    </tr>
                    <tr class="options_barFontSize">
                        <td><label class="translate" for="barFontSize">Label font size:</label></td>
                        <td><input id="barFontSize" class="value input"></td>
                    </tr>
                    <tr class="options_barFontColor">
                        <td><label class="translate" for="barFontColor">Label color:</label></td>
                        <td>
                            <table class="no-spaces"><tr><td><input type="text" class="value input input-static-color" id="barFontColor"></td><td><button data-clear="barFontColor" class="clear-button" style="display: inline-block"></button></td></tr></table>
                        </td>
                    </tr>
                </table>

                <table style="margin-left: 25px; width: 300px">
                    <tr><td class="translate header" colspan="2" style="text-align: center">Title</td></tr>
                    <tr class="options_title">
                        <td class="translate">Title:</td>
                        <td><input type="text" id="title" class="value input"></td>
                    </tr>
                    <!-- Do not use values 50, 5, and -5. They are reserved for 50-middle/center, 5-inside at edge, -5 outside at edge -->
                    <tr class="options_titlePos">
                        <td class="translate">Title position:</td>
                        <td><select class="value input" id="titlePos">
                            <option value="" class="translate">none</option>
                            <option value="top:35;left:65" class="translate">Top, left, inside</option>
                            <option value="top:35;right:5" class="translate">Top, right, inside</option>
                            <option value="top:35;left:50" class="translate">Top, center, inside</option>
                            <option value="top:50;left:65" class="translate">Middle, left, inside</option>
                            <option value="top:50;right:5" class="translate">Middle, right, inside</option>
                            <option value="bottom:5;left:65" class="translate">Bottom, left, inside</option>
                            <option value="bottom:5;right:5" class="translate">Bottom, right, inside</option>
                            <option value="bottom:5;left:50" class="translate">Bottom, center, inside</option>

                            <option value="top:5;right:-5" class="translate">Top, right, outside</option>
                            <option value="top:50;right:-5" class="translate">Middle, right, outside</option>
                            <option value="bottom:5;right:-5" class="translate">Bottom, right, outside</option>
                            <option value="bottom:-5;left:50" class="translate">Bottom, center, outside</option>
                        </select></td>
                    </tr>
                    <tr class="options_titleColor">
                        <td><label class="translate" for="titleColor">Title color:</label></td>
                        <td><table class="no-spaces"><tr><td><input type="text" id="titleColor" class="value input input-static-color"></td><td><button data-clear="titleColor" class="clear-button" style="display: inline-block"></button></td></tr></table></td>
                    </tr>
                    <tr class="options_titleSize">
                        <td class="translate">Title size:</td>
                        <td><input type="text" id="titleSize" class="value input"></td>
                    </tr>

                </table>

                <table style="margin-left: 25px; width: 400px">
                    <tr><td class="translate header" colspan="2" style="text-align: center">Options</td></tr>
                    <tr class="options_legend">
                        <td class="translate">Show legend:</td>
                        <td><select class="value input" id="legend">
                            <option value="" class="translate">none</option>
                            <option value="nw" class="translate">Top, left</option>
                            <option value="ne" class="translate">Top, right</option>
                            <option value="sw" class="translate">Bottom, left</option>
                            <option value="se" class="translate">Bottom, right</option>
                        </select></td>
                    </tr>
                    <tr class="options_legColumns">
                        <td class="translate">Legend columns:</td>
                        <td><input type="number" class="value" id="legColumns"></td>
                    </tr>
                    <tr class="options_legBgOpacity">
                        <td><label class="translate" for="legBgOpacity">Legend opacity (from 0 to 1):</label></td>
                        <td><input class="value input" id="legBgOpacity"/></td>
                    </tr>
                    <tr class="options_legBg">
                        <td><label class="translate" for="legBg">Legend background:</label></td>
                        <td><table class="no-spaces"><tr><td><input class="value input input-static-color" id="legBg" style="display: inline-block"></td><td><button data-clear="legBg" class="clear-button" style="display: inline-block"></button></td></tr></table></td>
                    </tr>
                    <tr class="options_hoverDetail">
                        <td class="translate">Hover details:</td>
                        <td><input type="checkbox" class="value" id="hoverDetail"></td>
                    </tr>
                    <tr class="options_timeFormat">
                        <td class="translate">Time format:</td>
                        <td><select class="value input" id="timeFormat">
                            <option value="" class="translate">Default</option>
                            <option value="%H:%M %d.%m">HH:MM dd.mm</option>
                            <option value="%H:%M %d.%m.">HH:MM dd.mm.</option>
                            <option value="%H:%M <br> %d.%m">HH:MM / dd.mm</option>
                            <option value="%H:%M <br> %d.%m.">HH:MM / dd.mm.</option>
                            <option value="%H:%M <br> %d.%m.%y">HH:MM / dd.mm.yy</option>
                            <option value="%H:%M:%S %d.%m.%y">HH:MM:SS dd.mm.yy</option>
                            <option value="%H:%M %d.%m.%y">HH:MM dd.mm.yy</option>
                            <option value="%I:%M:%S %x %p">HH:MM:SS mm/dd/yy am (US)</option>
                            <option value="%H:%M:%S %d/%m/%y">HH:MM:SS dd/mm/yy (UK)</option>
                            <option value="%H:%M:%S %m.%d.%y">HH:MM:SS mm.dd.yy</option>
                            <option value="%H:%M %m.%d">HH:MM mm.dd</option>
                            <option value="%H:%M:%S">HH:MM:SS</option>
                            <option value="%H:%M">HH:MM</option>
                            <option value="%d.%m.%y">dd.mm.yy</option>
                        </select></td>
                    </tr>
                    <tr class="options_smoothing">
                        <td class="translate">Smoothing:</td>
                        <td><input type="text" class="value input" id="smoothing"></td>
                    </tr>
                    <!--tr class="options_afterComma">
                        <td class="translate">After comma:</td>
                        <td><input type="text" class="value input" id="afterComma"></td>
                    </tr-->
                    <tr class="options_useComma">
                        <td class="translate">Use comma:</td>
                        <td><input type="checkbox" class="value" id="useComma"></td>
                    </tr>
                    <tr class="options_zoom">
                        <td class="translate">Enable zoom and pan:</td>
                        <td><input type="checkbox" class="value" id="zoom"></td>
                    </tr>
                    <tr class="options_noedit">
                        <td class="translate">Hide edit button:</td>
                        <td><input type="checkbox" class="value" id="noedit"></td>
                    </tr>
                    <tr class="options_animation">
                        <td class="translate">Animation:</td>
                        <td><select class="value input" id="animation">
                            <option value="0" class="translate">no</option>
                            <option value="300" class="translate">300ms</option>
                            <option value="500" class="translate">500ms</option>
                            <option value="1000" class="translate">1s</option>
                            <option value="2000" class="translate">2s</option>
                            <option value="3000" class="translate">3s</option>
                            <option value="5000" class="translate">5s</option>
                            <option value="10000" class="translate">10s</option>
                        </select></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="version">Version: 1.6.0</div>
    </div>
    <div style="height: 70px; display: flex; justify-content: space-around; align-items: center; margin-top: 10px; margin-bottom: 10px">
        <label class="translate" for="link">Link</label>
        <textarea id="link" style="width: calc(100% - 260px); height: 55px; word-break: break-all; resize: none"></textarea>
        <button style="padding-left: 2px" id="open"          class="translateB">Open</button>
        <button style="padding-left: 5px" id="updatePreview" class="translateB">update Preview</button>
    </div>
</div>
<iframe src="index.html" style="width: calc(100% - 20px); bottom: 0; height: calc(100% - 380px); border: 1px solid #afafaf; border-radius: 2px" id="chart"></iframe>
<div id="dialog-select-member" style="display: none"></div>

<div id="dialog-line-options" style="display: none">
    <table>
    </table>
</div>
<script>
    'use strict';

    var defaultColors   = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000', '#800080', '#008080'];
    var instances       = [];
    var timer           = null;
    var showTimer       = null;
    var defaultHistory  = '';

    // hide/show settings
    if (settings.maxLines < 2) $('#ids_add').hide();
    for (var s in settings) {
        if (!settings.hasOwnProperty(s)) continue;
        if (typeof settings[s] === 'object' && settings[s].enabled === false) {
            $('.' + s).remove();
        }
    }

    var setup = {
        options: {
            l: []
        }
    };

    addLine();

    var path = location.href.split('?')[1];
    if (path) {
        setup.options = deparam(path || '');
        // for compatibility. Not used any more
        if (setup.options._ids) {
            var ids    = setup.options._ids    ? setup.options._ids.split(';')    : [];
            var colors = setup.options._colors ? setup.options._colors.split(';') : [];
            var names  = setup.options._names  ? setup.options._names.split(';')  : [];
            var units  = setup.options._units  ? setup.options._units.split(';')  : [];
            setup.options.l = [];
            for (var i = 0; i < ids.length; i++) {
                setup.options.l.push({
                    id:         ids[i],
                    offset:     0,
                    name:       names[i] || '',
                    aggregate:  'minmax',
                    color:      colors[i] || 'blue',
                    thickness:  setup.options.strokeWidth || 1,
                    shadowsize: setup.options.strokeWidth || 1,
                    smoothing:  setup.options.smoothing   || 0,
                    afterComma: setup.options.afterComma  || 0,
                    min:        setup.options.min || '',
                    max:        setup.options.max || '',
                    unit:       units[i]          || ''
                });
            }
            setup.options.aggregateType = 'step';
            setup.options.aggregateSpan = 300;
            setup.options.relativeEnd   = 'now';
            if (setup.options._colors)  delete setup.options._colors;
            if (setup.options._names)   delete setup.options._names;
            if (setup.options._ids)     delete setup.options._ids;
        }
        setup.options.l = setup.options.l || [];
    }

    // convert art to aggregate
    for (var j = 0; j < setup.options.l.length; j++) {
        if (setup.options.l[j].art) {
            setup.options.l[j].aggregate = setup.options.l[j].art;
            delete setup.options.l[j].art;
        }
    }
    // rename timeArt
    if (setup.options.timeArt) {
        setup.options.timeType = setup.options.timeArt;
        delete setup.options.timeArt;
    }

    if (typeof sysLang !== 'undefined') systemLang = sysLang || 'en';

    $('#dialog-select-member').selectId('init', {
        filter: {
            common: {
                custom: true
            }
        },
        noMultiselect: true,
        connCfg: {
            socketUrl:      	socketUrl,
            socketSession:  	socketSession,
            socketName:     	'flotEdit',
			upgrade:            typeof socketForceWebSockets !== 'undefined' ? !socketForceWebSockets : undefined,
			rememberUpgrade:    typeof socketForceWebSockets !== 'undefined' ? socketForceWebSockets  : undefined,
			transports:         typeof socketForceWebSockets !== 'undefined' ? (socketForceWebSockets ? ['websocket'] : undefined) : undefined
        },
        columns: ['name', 'role', 'room', 'value'],
        texts: {
            select:     _('Select'),
            cancel:     _('Cancel'),
            all:        _('All'),
            id:         _('ID'),
            name:       _('Name'),
            role:       _('Role'),
            room:       _('Room'),
            value:      _('Value'),
            selectid:   _('Select ID'),
            from:       _('From'),
            lc:         _('Last changed'),
            ts:         _('Time stamp'),
            wait:       _('Processing...'),
            ack:        _('Acknowledged')
        }
    });

    function addLine() {
        if (!setup.options.l) setup.options.l = [];
        var index = setup.options.l.length;

        setup.options.l.push({
            id:         '',
            instance:   '',
            offset:     0,
            aggregate:  'minmax',
            color:      defaultColors[index] || '#00FFFF',
            min:        '',
            max:        '',
            thickness:  3,
            shadowsize: 3,
            unit:       '',
            name:       ''
        });

        return index;
    }

    function addMarkline() {
        if (!setup.options.m) setup.options.m = [];
        var index = setup.options.m.length;
        setup.options.m.push({
            l: 0, // line index
            v: 0, // value
            f: false,
            c: defaultColors[index] || '#00FFFF', // color
            t: 3, // thickness
            s: 3, // shadowsize
            d: '', // description
            p: 'l', // position : left / right
            py: 0, // description y offset
            fc: defaultColors[index] || '#00FFFF', // color of text
            fs: '' // font-size
        });

        return index;
    }

    function showMarklines(callback) {
        setTimeout(function () {
            if (!settings.option_markline) {
                $('.markline-option').hide();
                return;
            }

            var text = '';
            // line index
            var textLines = '';
            for (var t = 0; t < setup.options.l.length; t++) {
                textLines += '<option value="' + t + '">' + t + ' - ' + setup.options.l[t].id + '</option>\n';
            }

            var textPosition = '<option value="l">' + _('Left')    + '</option>';
            textPosition += '<option value="r">'    + _('Right')   + '</option>';

            if (setup.options.m) {
                for (var i = 0; i < setup.options.m.length; i++) {
                    text += '<tr>';
                    // line index
                    text += '<td><select class="markline-value" data-index="' + i + '" data-option="l" style="width: 95%">' + textLines + '</select></td>';

                    // upper value
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="v" style="width: 200px;display: inline"/></td>';
                    text += '<td><button style="display: inline; margin-right: 15px;" class="markline-select-dialog" data-index="' + i + '" data-option="v">...</button></td>';
                    // lower value
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="vl" style="width: 200px;display: inline"/></td>';
                    text += '<td><button style="display: inline; margin-right: 15px;" class="markline-select-dialog" data-index="' + i + '" data-option="vl">...</button></td>';
                    // color
                    text += '<td><input class="markline-value markline-color" data-index="' + i + '" data-option="c"/ style="width: 100px"></td>';
                    // fill
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="f" type="checkbox"/></td>';
                    // thickness
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="t" type="number" min="1" style="width: 60px"/></td>';
                    // shadowsize
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="s" type="number" min="0" style="width: 60px"/></td>';
                    // description
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="d" style="width: 95%"/></td>';
                    // description position
                    text += '<td><select class="markline-value" data-index="' + i + '" data-option="p">' + textPosition + '</select></td>';
                    // description-offset
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="py" type="number" style="width: 60px"/></td>';
                    // font-size
                    text += '<td><input class="markline-value" data-index="' + i + '" data-option="fs" type="number" min="0" style="width: 60px"/></td>';
                    // font-color
                    text += '<td><input class="markline-value markline-color" data-index="' + i + '" data-option="fc" style="width: 100px"/></td>';
                    // delete
                    text += '<td><button class="markline-remove" data-index="' + i + '"></button></td>\n';

                    text += '</tr>';
                }
            }
            $('#markline_list').html(text);

            $('.markline-value').each(function () {
                var id = $(this).data('index');
                var name = $(this).data('option');
                if ($(this).attr('type') === 'checkbox') {
                    if (setup.options.m[id][name] === 'true')  setup.options.m[id][name] = true;
                    if (setup.options.m[id][name] === 'false') setup.options.m[id][name] = false;
                    $(this).prop('checked', !!setup.options.m[id][name]);
                } else {
                    $(this).val(setup.options.m[id][name]);
                }
            });

            /*$('.markline-color').colorPicker({
                renderCallback: function ($elm, toggled) {
                    if (toggled === false) {
                        $elm.trigger('change');
                    }
                }
            });*/
            $('.markline-color').colorpicker({
                colorFormat: '#HEX'
            }).on('change', function () {
                $(this).css({'background-color': $(this).val(), color: invertColor($(this).val())});
            }).trigger('change');

            $('.markline-remove').button({
                icons: {primary: 'ui-icon-trash'},
                text: false
            }).click(function () {
                if (setup.options.m.length) {
                    var i = $(this).data('index');
                    setup.options.m.splice(i, 1);
                    showMarklines();
                    save();
                    delayedUpdate();
                }
            }).css({width: 22, height: 22});

            $('.markline-select-dialog').button({
                text: false,
                icons: {
                    primary: 'ui-icon-folder-open'
                }
            }).css({width: 25, height: 22}).click(function () {
                var index = $(this).data('index');
                var attr  = $(this).data('option');
                $('#dialog-select-member').selectId('show', setup.options.m[index][attr], {
                            common: {
                                custom: false
                            }
                        },
                        function (newId, ignore, obj) {
                            setup.options.l[index][attr] = newId;
                            $('.markline-value[data-index="' + index + '"][data-option="' + attr + '"]').val(newId).trigger('change');
                        });
            });
        }, 100);
    }

    function showOptionsDialog(index) {
        var options = setup.options.l[index];
        $('#dialog-line-options').data('index', index);

        if (!$('#dialog-line-options').data('inited')) {
            $('#dialog-line-options').data('inited', true);

            var count = 0;
            var text = '';
            for (var attr in settings.extraOptions) {
                count++;
                text += '<tr ' + (settings.extraOptions[attr].title ? 'title="' + settings.extraOptions[attr].title + '" ' : '') + '>';
                text += '<td><label for="option_' + attr + '">' + _(settings.extraOptions[attr].name || attr) + '</label></td>';
                if (attr === 'offset') {
                    text += '<td><select id="option_' + attr + '" ' +
                            'style="' + (settings.extraOptions[attr].width ? 'width: ' + settings.extraOptions[attr].width + ';': '') + (settings.extraOptions[attr].style || '') + '" ' +
                            'class="dialog-line-option ' + (settings.extraOptions[attr]._class || '') + '" ' +
                            'data-option="' + attr + '">\n';
                    text +=
                            '<option value="0">'        + _('0s')   + '</option>' +
                            '<option value="10">'       + _('10s')  + '</option>' +
                            '<option value="30">'       + _('30s')  + '</option>' +
                            '<option value="60">'       + _('60s')  + '</option>' +
                            '<option value="120">'      + _('2m')   + '</option>' +
                            '<option value="180">'      + _('3m')   + '</option>' +
                            '<option value="240">'      + _('4m')   + '</option>' +
                            '<option value="300">'      + _('5m')   + '</option>' +
                            '<option value="600">'      + _('10m')  + '</option>' +
                            '<option value="900">'      + _('15m')  + '</option>' +
                            '<option value="1800">'     + _('30m')  + '</option>' +
                            '<option value="2700">'     + _('45m')  + '</option>' +
                            '<option value="3600">'     + _('1H')   + '</option>' +
                            '<option value="7200">'     + _('2H')   + '</option>' +
                            '<option value="21600">'    + _('6H')   + '</option>' +
                            '<option value="43200">'    + _('12H')  + '</option>' +
                            '<option value="86400">'    + _('1D')   + '</option>' +
                            '<option value="172800">'   + _('2D')   + '</option>' +
                            '<option value="259200">'   + _('3D')   + '</option>' +
                            '<option value="345600">'   + _('4D')   + '</option>' +
                            '<option value="604800">'   + _('1W')   + '</option>' +
                            '<option value="1209600">'  + _('2W')   + '</option>' +
                            '<option value="1m">'       + _('1M')   + '</option>' +
                            '<option value="2m">'       + _('2M')   + '</option>' +
                            '<option value="3m">'       + _('3M')  + '</option>' +
                            '<option value="6m">'       + _('6M')  + '</option>' +
                            '<option value="1y">'       + _('1Y')   + '</option>' +
                            '<option value="2y">'       + _('2Y')   + '</option>';
                    text += '</select></td>\n';
                } else
                if (!settings.extraOptions[attr].values) {
                    text += '<td><input id="option_' + attr + '" class="dialog-line-option" data-option="' + attr + '" ' +
                            (settings.extraOptions[attr].type ? 'type="' + settings.extraOptions[attr].type + '" ' : '') +
                            ' style="' + (settings.extraOptions[attr].width ? 'width: ' + settings.extraOptions[attr].width + ';': '') + (settings.extraOptions[attr].style || '') + '" ' +
                            (settings.extraOptions[attr].default !== undefined ? 'data-default="' + settings.extraOptions[attr].default + '"' : '') +
                            '/></td>';
                } else {
                    text += '<td><select id="option_' + attr + '" class="dialog-line-option" data-option="' + attr + '" ' +
                            (settings.extraOptions[attr].type ? 'type="' + settings.extraOptions[attr].type + '" ' : '') +
                            ' style="' + (settings.extraOptions[attr].width ? 'width: ' + settings.extraOptions[attr].width + ';': '') + (settings.extraOptions[attr].style || '') + '" ' +
                            (settings.extraOptions[attr].default !== undefined ? 'data-default="' + settings.extraOptions[attr].default + '"' : '') +
                            '>';
                    for (var opt = 0; opt < settings.extraOptions[attr].values.length; opt++) {
                        text += '<option value="' + settings.extraOptions[attr].values[opt] + '">' +
                                (settings.extraOptions[attr].names && settings.extraOptions[attr].names[opt] !== undefined ?
                                        _(settings.extraOptions[attr].names[opt]) : settings.extraOptions[attr].values[opt])  +
                                '</option>';
                    }

                    text += '</select></td>';
                }
                text += '</tr>';
            }
            $('#dialog-line-options').find('table').html(text);

            $('#dialog-line-options').dialog({
                autoOpen:   false,
                modal:      true,
                width:      430,
                resizable:  false,
                height:     count * 32 + 120,
                buttons: [
                    {
                        text: _('Ok'),
                        click: function () {
                            var index = $('#dialog-line-options').data('index');
                            var changed = false;
                            var options = setup.options.l[index];
                            $('#dialog-line-options').find('.dialog-line-option').each(function () {
                                var attr = $(this).data('option');

                                if ($(this).attr('type') === 'checkbox') {
                                    if ($(this).prop('checked') !== options[attr]) {
                                        changed = true;
                                        options[attr] = $(this).prop('checked');
                                    }
                                } else {
                                    if ($(this).val() != options[attr]) {
                                        changed = true;
                                        options[attr] = $(this).val();
                                    }
                                }
                            });

                            if (changed) update();

                            $('#dialog-line-options').dialog('close');
                        }
                    },
                    {
                        text: _('Cancel'),
                        click: function () {
                            $('#dialog-line-options').dialog('close');
                        }
                    }
                ]
            });

        }


        $('#dialog-line-options').find('.dialog-line-option').each(function () {
            var attr = $(this).data('option');
            if ($(this).attr('type') === 'checkbox') {
                if (options[attr] === 'true')  options[attr] = true;
                if (options[attr] === 'false') options[attr] = false;
                if ($(this).data('default') !== null && $(this).data('default') !== undefined &&
                        (options[attr] === undefined || options[attr] === '' || options[attr] === null)) {
                    options[attr] = $(this).data('default') === 'true';
                }
                $(this).prop('checked', options[attr] === true);
            } else {
                if ($(this).data('default') !== null && $(this).data('default') !== undefined &&
                        (options[attr] === undefined || options[attr] === '' || options[attr] === null)) {
                    options[attr] = $(this).data('default');
                }
                $(this).val(options[attr] === undefined ? '' : options[attr]);
            }
        });

        $('#dialog-line-options').dialog('option', 'title', _('Edit options for line %s', index + 1));
        $('#dialog-line-options').dialog('open');
    }

    function showIds(callback) {
        setTimeout(function () {
            var text = '';
            var colgroup = '<colgroup>\n';
            var thead    = '<tr style="text-align: center" class="header">\n';

            var textInstances = '<option value="">' + _('default') + '</option>\n';
            for (var t = 0; t < instances.length; t++) {
                textInstances += '<option value="' + instances[t] + '">' + instances[t] + '</option>\n';
            }

            var colindex = 0;
            for (var s in settings.line) {
                if (settings.line[s].enabled) {
                    colgroup += '<col data-index="' + colindex + '" ' + (settings.line[s].width ? 'width="' + settings.line[s].width + '"' : '') + ' />\n';
                    thead    += '<th class="toggleable" data-index="' + colindex + '" title="' + _(settings.line[s].title) + '" ' + (settings.line[s].width ? 'width="' + settings.line[s].width + '"' : '') + '>' + _(settings.line[s].name) + '</th>\n';
                    colindex++;
                }
            }
            colgroup += '</colgroup>';
            thead += '</tr>';

            for (var i = 0; i < setup.options.l.length && i < settings.maxLines; i++) {
                var line = setup.options.l[i];

                text += '<tr data-index="' + i + '" class="inputData">\n';
                for (var s in settings.line) {
                    if (!settings.line[s].enabled) continue;
                    settings.line[s].style  = settings.line[s].style  || '';
                    settings.line[s]._class = settings.line[s]._class || '';

                    if (s === 'min') {
                        line.min = (line.min === undefined) ? '' : line.min;
                    } else
                    if (s === 'max') {
                        line.max = (line.max === undefined) ? '' : line.max;
                    }

                    if (s === 'number') {
                        text +='<td title="' + _('Line') + ' ' + (i + 1) + '">' + (i + 1) + '</td>\n';
                    } else
                    if (s === 'idSelect') {
                        text += '<td><button style="display: inline" class="select-dialog" data-index="' + i + '" data-ids="' + i + '">...</button></td>\n';
                    } else
                    if (s === 'instance') {
                        text += '<td style="' + settings.line[s].style + '"><select data-option="' + s + '" data-index="' + i + '" class="input options-lines' + settings.line[s]._class + '" style="display: inline;" value="' + (line[s] || '') + '">' + textInstances + '</select></td>\n';
                    } else
                    if (s === 'offset') {
                        text += '<td style="' + settings.line[s].style + '">\n';
                        text += '<select class="input options-lines ' + settings.line[s]._class + '" data-index="' + i + '" data-option="' + s + '">\n';
                        text +=
                                '<option value="0">'        + _('0s')   + '</option> ' +
                                '<option value="10">'       + _('10s')  + '</option>' +
                                '<option value="30">'       + _('30s')  + '</option>' +
                                '<option value="60">'       + _('60s')  + '</option>' +
                                '<option value="120">'      + _('2m')   + '</option>' +
                                '<option value="180">'      + _('3m')   + '</option>' +
                                '<option value="240">'      + _('4m')   + '</option>' +
                                '<option value="300">'      + _('5m')   + '</option>' +
                                '<option value="600">'      + _('10m')  + '</option>' +
                                '<option value="900">'      + _('15m')  + '</option>' +
                                '<option value="1800">'     + _('30m')  + '</option>' +
                                '<option value="2700">'     + _('45m')  + '</option>' +
                                '<option value="3600">'     + _('1H')   + '</option>' +
                                '<option value="7200">'     + _('2H')   + '</option>' +
                                '<option value="21600">'    + _('6H')   + '</option>' +
                                '<option value="43200">'    + _('12H')  + '</option>' +
                                '<option value="86400">'    + _('1D')   + '</option>' +
                                '<option value="172800">'   + _('2D')   + '</option>' +
                                '<option value="259200">'   + _('3D')   + '</option>' +
                                '<option value="345600">'   + _('4D')   + '</option>' +
                                '<option value="604800">'   + _('1W')   + '</option>' +
                                '<option value="1209600">'  + _('2W')   + '</option>' +
                                '<option value="1m">'       + _('1M')   + '</option>' +
                                '<option value="2m">'       + _('2M')   + '</option>' +
                                '<option value="3m">'       + _('3M')  + '</option>' +
                                '<option value="6m">'       + _('6M')  + '</option>' +
                                '<option value="1y">'       + _('1Y')   + '</option>' +
                                '<option value="2y">'       + _('2Y')   + '</option>';
                        text += '</select></td>\n';
                    } else
                    if (s === 'removeButton') {
                        text += '<td style="' + settings.line[s].style + '"><button class="id-remove" data-index="' + i + '"></button></td>\n';
                    } else if (s === 'extraOptions') {
                        text += '<td style="' + settings.line[s].style + '"><button class="id-options" data-index="' + i + '"></button></td>\n';
                    } else {
                        text += '<td style="' + settings.line[s].style + '">\n';
                        if (settings.line[s].values) {
                            text += '<select data-option="' + s + '" class="input options-lines ' + settings.line[s]._class + '" data-index="' + i + '" value="' + (line[s] || settings.line[s].default || '') + '">\n';
                            for (var a = 0; a < settings.line[s].values.length; a++) {
                                text += '<option value="' + settings.line[s].values[a] + '">' + _(settings.line[s].values[a]) + '</option>\n';
                            }
                            text += '</select>\n';
                        } else {
                            text += '<input data-option="' + s + '" type="' + (settings.line[s].type || 'text') + '" style="width: 100%; ' + (settings.line[s].inputStyle || '') + '" data-index="' + i + '" class="options-lines ' + settings.line[s]._class + '" value="' + (line[s] || settings.line[s].default || '') + '">\n';
                        }
                        text += '</td>\n';
                    }
                }

                text += '</tr>';
            }

            $('#idslist').html(thead + text);

            /*$('.input-color').colorPicker({
                renderCallback: function ($elm, toggled) {
                    if (toggled === false) {
                        $elm.trigger('change');
                    }
                }
            });*/
            if (systemLang === 'de') {
                $.colorpicker.regional = {
                    '': {
                        ok: 'OK',
                        cancel: 'Abbrechen',
                        none: 'Nichts',
                        button: 'Farbe',
                        title: 'Farbe wählen',
                        transparent: 'Transparent',
                        hsvH: 'H',
                        hsvS: 'S',
                        hsvV: 'V',
                        rgbR: 'R',
                        rgbG: 'G',
                        rgbB: 'B',
                        labL: 'L',
                        labA: 'a',
                        labB: 'b',
                        hslH: 'H',
                        hslS: 'S',
                        hslL: 'L',
                        cmykC: 'C',
                        cmykM: 'M',
                        cmykY: 'Y',
                        cmykK: 'K',
                        alphaA: 'A'
                    }
                };
            } else if (systemLang === 'ru') {
                $.colorpicker.regional = {
                    '': {
                        ok: 'OK',
                        cancel: 'Отмена',
                        none: 'Нет',
                        button: 'Цвет',
                        title: 'Выбрать цвет',
                        transparent: 'Прозрачность',
                        hsvH: 'H',
                        hsvS: 'S',
                        hsvV: 'V',
                        rgbR: 'R',
                        rgbG: 'G',
                        rgbB: 'B',
                        labL: 'L',
                        labA: 'a',
                        labB: 'b',
                        hslH: 'H',
                        hslS: 'S',
                        hslL: 'L',
                        cmykC: 'C',
                        cmykM: 'M',
                        cmykY: 'Y',
                        cmykK: 'K',
                        alphaA: 'A'
                    }
                };
            }

            $('.input-color').colorpicker({
                colorFormat: '#HEX'
            }).on('change', function () {
                $(this).css({'background-color': $(this).val(), color: invertColor($(this).val())});
            }).trigger('change');

            $('.id-remove').button({
                icons: {primary: 'ui-icon-trash'},
                text: false
            }).click(function () {
                if (setup.options.l.length) {
                    var i = $(this).data('index');
                    setup.options.l.splice(i, 1);
                    if (!setup.options.l.length) {
                        addLine();
                    }
                    showIds();
                    save();
                    delayedUpdate();
                }
            }).css({width: 22, height: 22});

            $('.id-options').button({
                icons: {primary: 'ui-icon-gear'},
                text: false
            }).click(function () {
                showOptionsDialog($(this).data('index'));
            }).css({width: 22, height: 22});

            $('.select-dialog').button({
                text: false,
                icons: {
                    primary: 'ui-icon-folder-open'
                }
            }).css({width: 25, height: 22}).click(function () {
                var index = $(this).data('index');
                // get instance
                var instance = $('[data-option="instance"][data-index="' + index + '"]').val();
                if (!instance) instance = defaultHistory;

                $('#dialog-select-member').selectId('show', setup.options.l[index].id, {
                        common: {
                            custom: instance
                        }
                    },
                    function (newId, ignore, obj) {
                    setup.options.l[index].id = newId;
                    $('.ids[data-index="' + index + '"]').val(newId).trigger('change');
                    if (obj && obj.common.type === 'boolean') {
                        $('select[data-option="aggregate"][data-index="' + index + '"]').val('onchange').trigger('change');
                        $('select[data-option="chartType"][data-index="' + index + '"]').val('steps').trigger('change');
                        $('input[data-option="min"][data-index="' + index + '"]').val(0).trigger('change');
                        $('input[data-option="max"][data-index="' + index + '"]').val(10).trigger('change');
                    }
                    showIds();
                });
            });

            $('.options-lines').each(function () {
                var $this = $(this);
                var index = $(this).data('index');
                var opt   = $(this).data('option');

                if (setup.options.l[index][opt] !== undefined) {
                    if ($this.attr('type') === 'checkbox') {
                        if (setup.options.l[index][opt] === 'true')  setup.options.l[index][opt] = true;
                        if (setup.options.l[index][opt] === 'false') setup.options.l[index][opt] = false;

                        $this.prop('checked', !!setup.options.l[index][opt]);
                    } else {
                        $this.val(setup.options.l[index][opt]);
                    }
                }
            });
            $('.spinner-lines').attr('type', 'number');
            /*$('.spinner-lines').spinner().on('stop', function () {
                $(this).trigger('change');
            }).parent().addClass('input');*/

            if (typeof callback === 'function') callback();

            $('.toggleable').click(function () {
                var index = $(this).data('index');
                var $col = $('col[data-index="' + index + '"]');
                if (!$col.data('width')) $col.data('width', $col.attr('width'));
                if ($col.data('hidden')) {
                    $col.data('hidden', false);
                    $col.attr('width', $col.data('width'));
                    $(this).css('width', $col.data('width'));
                } else {
                    $col.data('hidden', true);
                    $col.attr('width', '10px');
                    $(this).css('width', '10px');
                }
            });
            $('select[data-option="chartType"]').on('change', function () {
                if ($(this).val() === 'spline') {
                    alert('Experimental');
                }
            });

            showMarklines();
        }, 100);
    }

    function getSettings() {
        var _options = JSON.parse(JSON.stringify(setup.options));

        // clean options
        for (var y in _options){
            if (_options[y] === ''){
                delete _options[y];
            }
        }

        // clean lines
        for (var i = 0; i < _options.l.length; i++) {
            if (_options.l[i].id === ''){
                _options.l.splice(i, 1);
                i--;
            } else {
                for (var x in _options.l[i]) {
                    if (_options.l[i][x] === '') {
                        delete _options.l[i][x];
                    }
                }
            }
        }

        var params = $.param(_options);

        //console.log(deparam(params));

        return params;
    }

    function delayedUpdate() {
        if (timer) clearTimeout(timer);
        timer = setTimeout(update, 500);
    }

    function update() {
        clearTimeout(timer);
        timer = null;

        // Store settings
        if (typeof(Storage) !== 'undefined') {
            $('.value').each(function () {
                if ($(this).attr('type') === 'checkbox') {
                    setup.options[$(this).attr('id')] = $(this).prop('checked');
                } else {
                    setup.options[$(this).attr('id')] = $(this).val();
                }
            });

            save();
        }
        var settings = getSettings();
        $('#link').val(location.href.split('?')[0].replace('edit.html', 'index.html') + '?' + settings);
        $('#updatePreview').button('option', 'disabled', false);

        if ($('#aggregateType').val() === 'step') {
            $('#spanName').text(_('Seconds') + ':');
        } else {
            $('#spanName').text(_('Counts') + ':');
        }

        $('.relative, .static').hide();

        $('.' + $('#timeType').val()).show();

        if ($('#autoUpdate').prop('checked')) {
            delayedPreview();
            $('#updatePreview').hide();
        }

        // calculate span
        var text = '';
        if (setup.options.timeType === 'relative') {
            text =  _('%s ago', $('#range option:selected').text()) + ' - ' + _(setup.options.relativeEnd);
        } else {
            text = new Date(setup.options.start).toLocaleDateString() + ' ' +
                   new Date(setup.options.start + ' ' + setup.options.start_time).toLocaleTimeString() + ' - ' +
                   new Date(setup.options.end).toLocaleDateString() + ' ' +
                   new Date(setup.options.end + ' ' + setup.options.end_time).toLocaleTimeString();
        }
        $('#time_span').html('[' + text + ']');
    }

    function save() {
        if (typeof(Storage) !== 'undefined') {
            localStorage.setItem('iobroker.Flot', JSON.stringify(setup));
       }
    }

    function delayedPreview() {
        if (showTimer) clearTimeout(showTimer);
        showTimer = setTimeout(updatePreview, 500);
    }

    function updatePreview() {
        if (parseInt($('#height').val())) {
            $('#chart').css({height: (parseInt($('#height').val()) || 500) + 90});
        } else {
            $('#chart').css({height: 'calc(100% - 350px)'});
        }

        var settings = getSettings();
        $('#chart').attr('src', '');
        setTimeout(function () {
            $('#chart').attr('src', 'index.html?' + settings + '&' + (new Date()).getTime());
        }, 0);

        $('#updatePreview').button('option', 'disabled', true);
    }

    function invertColor(hexcolor){
        hexcolor = hexcolor.replace('#', '');
        var r = parseInt(hexcolor.substr(0, 2), 16);
        var g = parseInt(hexcolor.substr(2, 2), 16);
        var b = parseInt(hexcolor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }
    
    $(document).ready(function() {
        if (typeof(Storage) !== 'undefined') {
            var _setup = localStorage.getItem('iobroker.Flot');
            if (_setup) {
                try {
                    _setup = JSON.parse(_setup);
                    if (path) {
                        _setup.options = setup.options;
                        setup = _setup;
                        save();
                        document.location.href = document.location.href.split('?')[0];
                    } else if (_setup.options) {
                        setup = _setup;
                    }
                }
                catch (e) {
                    console.log('Cannot parse stored settings');
                }
            }
        }

        if (setup.options.lines) {
            setup.options.l = JSON.parse(JSON.stringify(setup.options.lines));
            delete setup.options.lines;
        }
        setup.options.ignoreNull   = undefined;
        setup.options.afterComma   = undefined;
        setup.options.smoothing    = undefined;

        if (!setup.options.l || !setup.options.l.length) addLine();

        $('#autoUpdate').change(function () {
            setup['auto-update'] = $(this).prop('checked') ? 'true' : 'false';
            update();
            if (setup['auto-update'] == 'true') {
                $('#updatePreview').hide();
            } else {
                $('#updatePreview').show();
            }
        }).prop('checked', setup['auto-update'] == 'true');

        $('#arrangeBools').button().click(function () {
            // arrange all boolean values automatically
            //  calculate
            var count = 0;
            var axis = null;
            for (var i = 0; i < setup.options.l.length; i++) {
                if (setup.options.l[i].chartType === 'steps') {
                    if (axis === null) axis = i;
                    count++;
                }
            }

            var t = 0;
            for (var i = 0; i < setup.options.l.length; i++) {
                if (setup.options.l[i].chartType === 'steps') {
                    setup.options.l[i].max          = Math.round(count * 2 * 1.2 * 10) / 10;
                    setup.options.l[i].commonYAxis  = axis + 1;
                    setup.options.l[i].yOffset      = Math.round(-(t + 1) * 1.2 * 10) / 10;
                    setup.options.l[i].min          = Math.round((-count * 1.2 - 0.1) * 10) / 10;
                    setup.options.l[i].yaxe         = 'off';
                    t++;
                }
                setup.options.l[i].min  = Math.round((-count * 1.2 - 0.1) * 10) / 10;
            }
            showIds();
            save();
            delayedUpdate();
        });

        $('#accordion')
            .on('change', '.options-lines', function () {
                var index = $(this).data('index');
                if ($(this).attr('type') === 'checkbox') {
                    setup.options.l[index][$(this).data('option')] = $(this).prop('checked');
                } else {
                    setup.options.l[index][$(this).data('option')] = $(this).val();
                }
                if ($(this).hasClass('spinner-lines')) {
                    delayedUpdate();
                } else {
                    update();
                }
            })
            .on('keyup', '.options-lines', function () {
                $(this).trigger('change');
            });

        $('#accordion')
                .on('change', '.markline-value', function () {
                    var index = $(this).data('index');
                    if ($(this).attr('type') === 'checkbox') {
                        setup.options.m[index][$(this).data('option')] = $(this).prop('checked') ? 1 : 0;
                    } else {
                        setup.options.m[index][$(this).data('option')] = $(this).val();
                    }
                    update();
                })
                .on('keyup', '.markline-value', function () {
                    $(this).trigger('change');
                });

        $('.value').each(function () {
            var $this = $(this);
            var id = $this.attr('id');
            if (setup.options[id] !== undefined) {
                if ($this.attr('type') === 'checkbox') {
                    if (setup.options[id] === 'true')  setup.options[id] = true;
                    if (setup.options[id] === 'false') setup.options[id] = false;
                    $this.prop('checked', !!setup.options[id]);
                } else {
                    $this.val(setup.options[id]);
                }
            }
        });

        $('#ids_add').button({
            icons: {secondary: 'ui-icon-plus'},
            text: true
        }).click(function () {
            addLine();
            showIds();
        }).css({height: 30});

        $('#markline_add').button({
            icons: {secondary: 'ui-icon-plus'},
            text: true
        }).click(function () {
            addMarkline();
            showMarklines();
        }).css({height: 30});

        $('#clear').button({
            icons: {primary: 'ui-icon-trash'},
            text: false
        }).click(function () {
            localStorage.setItem('iobroker.Flot', JSON.stringify({reset: true}));
            location.reload();
        }).css({width: 30, height: 30});

        $('.value').change(function () {
            if ($(this).hasClass('spinner') || $(this).hasClass('input-static-color')) {
                delayedUpdate();
            } else {
                update();
            }
        }).keyup(function () {
            $(this).trigger('change');
        });

        /*$('.input-static-color').colorPicker({
            renderCallback: function ($elm, toggled) {
                if (toggled === false) {
                    $elm.trigger('change');
                }
            }
        });*/
        $('.input-static-color').colorpicker({
            colorFormat: '#HEX'
        }).on('change', function () {
            $(this).css({'background-color': $(this).val(), color: invertColor($(this).val())});
        }).trigger('change');

        $('.clear-button').hide();/*.button({
            icons: {
                primary: 'ui-icon-trash'
            },
            text: false
        }).css({width: 22, height: 22}).click(function () {
            var id = $(this).data('clear');
            setTimeout(function () {
                $('#' + id)
                        .val('')
                        .css({color: '#000', 'background-color': '#FFF'});
                        //.trigger('change');
            }, 500);
        });*/

        $('#timeType').change(function () {
            $('.relative, .static').hide();
            $('.' + $(this).val()).show();
        });

        $('.spinner').attr('type', 'number');
        /*$('.spinner').spinner().on('stop', function () {
            $(this).trigger('change');
        }).parent().addClass('input');*/

        $('#bg_custom').change(function () {
            if ($(this).prop('checked')) {
                $('#bg').show();
                $('#bg_predefined').hide();
            } else {
                $('#bg').hide();
                $('#bg_predefined').show();
                $('#bg_predefined').val(0).trigger('change');
            }
        });

        $('#bg_predefined').change(function () {
            $('#bg').val($(this).val()).trigger('change');
        });

        $('#ticks_select').button({
            text: false,
            icons: {
                primary: 'ui-icon-folder-open'
            }
        }).css({width: 25, height: 22}).click(function () {
            $('#dialog-select-member').selectId('show', $('#ticks').val(), {
                    common: {
                        custom: true
                    }
                },
                function (newId, ignore, obj) {
                    if (newId) {
                        $('#ticks').val(newId).trigger('change');
                    }
                });
        });

        if (setup.options.bg || setup.options.bg === 0) {
            if (setup.options.bg && setup.options.bg.length < 3 && parseInt(setup.options.bg, 10).toString() == setup.options.bg) {
                $('#bg').hide();
                $('#bg_predefined').show().val(setup.options.bg);
            } else {
                $('#bg_custom').prop('checked', true);
                $('#bg').show();
                $('#bg_predefined').hide();
            }
        }

        $('#aggregateType').change(function () {
            if ($('#aggregateType').val() === 'step') {
                $('#spanName').text(_('Seconds'));
            } else {
                $('#spanName').text(_('Counts'));
            }
        });

//      $('#range').val(options.range);
//      $('#axeX').val(options.axeX);
        $('#updatePreview')
            .button({
                icons: {
                    primary: 'ui-icon-refresh'
                }
            })
            .click(updatePreview)
            .button('option', 'disabled', true)
            .css({'font-size': 14, 'white-space': 'nowrap'});

        $('#open').button({
            icons: {
                primary: 'ui-icon-play'
            }
        }).click(function () {
            window.open($('#link').val(), 'flot');
        }).css({'font-size': 14, 'white-space': 'nowrap'});


        translateAll();

        $('#accordion').tabs({
            active : parseInt(setup.acc) || 0,
            heightStyle: 'fill',
            animate: {
                easing: 'linear',
                duration: 200
            },
            activate: function (event, ui) {
                setup.acc = $(ui.newHeader).attr('id');
                save();
            }
        });

        // Read instances
        var socket = io.connect(socketUrl, {
            query:                          'key=' + socketSession,
            'reconnection limit':           10000,
            'max reconnection attempts':    Infinity,
            upgrade:                        typeof socketForceWebSockets !== 'undefined' ? !socketForceWebSockets : undefined,
            rememberUpgrade:                typeof socketForceWebSockets !== 'undefined' ? socketForceWebSockets  : undefined,
            transports:                     typeof socketForceWebSockets !== 'undefined' ? (socketForceWebSockets ? ['websocket'] : undefined) : undefined
        });

        socket.on('connect', function () {
            this.emit('name', 'flotEdit');
            this.emit('getObject', 'system.config', function (err, obj) {
                if (obj && obj.common) defaultHistory = obj.common.defaultHistory || 'history.0';
                // load history instances
                socket.emit('getObjectView', 'system', 'instance', {
                    startkey: 'system.adapter.',
                    endkey: 'system.adapter.\u9999'
                }, function (err, doc) {
                    if (!err && doc && doc.rows) {
                        if (doc.rows.length !== 0) {
                            for (var i = 0; i < doc.rows.length; i++) {
                                var obj = doc.rows[i].value;
                                if (obj && obj.type === 'instance' && obj.common && obj.common.type === 'storage') {
                                    if (instances.indexOf(obj._id.substring('system.adapter.'.length)) === -1) instances.push(obj._id.substring('system.adapter.'.length));
                                }
                            }
                        }
                    }
                    showIds();

                    update();

                    // not need to disconnect, because socket-io uses pool
                    //socket.disconnect();
                    //socket = null;
                });
            });
        });

        // Handler for .ready() called.
        var bottomElemOriginalHeight = $('#chart').height();
        $('#resizable1').resizable({
                autoHide: true,
                handles: 's',
                resize: function (e, ui) {
                    /*var parent = ui.element.parent();
                    var remainingSpace = parent.height() - ui.element.outerHeight();
                    var divTwo = ui.element.next();
                    var divTwoWidth = (remainingSpace - (divTwo.outerHeight() - divTwo.height())) / parent.height() * 100 + '%';
                    divTwo.width(divTwoWidth);*/
                    $('#chart').height(bottomElemOriginalHeight - (ui.element.outerHeight() - ui.originalSize.height));
                },
                stop: function (e, ui) {
                    bottomElemOriginalHeight = $('#chart').height();
                    /* var parent = ui.element.parent();
                    ui.element.css({height: ui.element.height() / parent.height() * 100 + '%'}); */
                }
            });
    });

</script>
</body>
</html>
